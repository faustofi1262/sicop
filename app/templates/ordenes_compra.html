<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>√ìrdenes de Compra</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .table-items input { min-width: 90px; }
  </style>
</head>
<body class="container py-4">
  <h3 class="mb-3">üßæ √ìrdenes de Compra</h3>

  {% if error_oc %}
  <div class="alert alert-danger">{{ error_oc }}</div>
  {% endif %}

  <!-- LISTA -->
  <div class="mb-4">
    <table class="table table-bordered table-striped table-sm">
      <thead class="thead-dark">
        <tr>
          <th>ID</th>
          <th>N¬∞ OC</th>
          <th>Fecha</th>
          <th>Proveedor</th>
          <th class="text-right">Total</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for r in ocs %}
        <tr>
          <td>{{ r[0] }}</td>
          <td>{{ r[1] }}</td>
          <td>{{ r[2] }}</td>
          <td>{{ r[3] }}</td>
          <td class="text-right">$ {{ '%.2f'|format(r[4] or 0) }}</td>
          <td>
            <a class="btn btn-info btn-sm" href="/informe/orden_compra/{{ r[0] }}">Imprimir</a>
            <form action="/admin/ordenes_compra/eliminar/{{ r[0] }}" method="POST" style="display:inline"
                  onsubmit="return confirm('¬øEliminar la OC {{ r[1] }}?');">
              <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="6" class="text-center">Sin √≥rdenes registradas</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <hr>

  <!-- FORMULARIO NUEVA OC -->
  <h5 class="text-primary">Nueva Orden de Compra</h5>
  <form method="POST" id="form-oc">
     <div class="form-group">
    <label>Seleccionar memo (Vicerrectorado Administrativo):</label>
    <select id="sel_tarea_memo" class="form-control form-control-sm">
      <option value="">-- Seleccione --</option>
      {% for t in tareas_memos %}
        <option value="{{ t[0] }}">{{ t[1] }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- id de la tarea para el POST -->
  <input type="hidden" name="tarea_id" id="tarea_id">

  <!-- ‚¨áÔ∏è Tus campos existentes de la OC -->
  <div class="form-group">
    <label>√Årea requirente</label>
    <input name="area_requirente" class="form-control form-control-sm">
  </div>

  <div class="form-group">
    <label>Objeto de contrataci√≥n</label>
    <textarea name="objeto" class="form-control form-control-sm"></textarea>
  </div>
   <div class="form-row">
      <div class="col-md-3">
        <label>N¬∞ Orden de Compra</label>
        <input name="numero_oc" class="form-control form-control-sm" required>
      </div>
      <div class="col-md-3">
        <label>Fecha</label>
        <input type="date" name="fecha" class="form-control form-control-sm" required>
      </div>
     </div>
    <div class="form-row mt-2">
      <div class="col-md-6">
        <label>N¬∞ Cert. Presupuestaria</label>
        <input name="cert_presupuestaria" class="form-control form-control-sm">
      </div>
    </div>

    <h6 class="mt-3">Datos del Proveedor</h6>
    <div class="form-row">
      <div class="col-md-6"><input name="proveedor" class="form-control form-control-sm" placeholder="Raz√≥n social"></div>
      <div class="col-md-3"><input name="ruc" class="form-control form-control-sm" placeholder="RUC"></div>
      <div class="col-md-3"><input name="telefono" class="form-control form-control-sm" placeholder="Tel√©fono"></div>
    </div>
    <div class="form-row mt-2">
      <div class="col-md-6"><input name="direccion" class="form-control form-control-sm" placeholder="Direcci√≥n"></div>
      <div class="col-md-6"><input name="correo" class="form-control form-control-sm" placeholder="Correo"></div>
    </div>

    <div class="form-row mt-2">
      <div class="col-md-3"><input name="proforma_num" class="form-control form-control-sm" placeholder="Proforma N¬∞"></div>
      <div class="col-md-3"><input type="date" name="proforma_fecha" class="form-control form-control-sm" placeholder="Fecha proforma"></div>
      <div class="col-md-3"><input name="contacto" class="form-control form-control-sm" placeholder="Contacto"></div>
      <div class="col-md-3"><input name="vigencia" class="form-control form-control-sm" placeholder="Vigencia"></div>
    </div>

    <h6 class="mt-3">Condiciones de Pago</h6>
    <div class="form-row">
      <div class="col-md-6"><input name="forma_pago" class="form-control form-control-sm" placeholder="Forma de pago"></div>
      <div class="col-md-6"><input name="plazo_ejecucion" class="form-control form-control-sm" placeholder="Plazo de ejecuci√≥n"></div>
    </div>
    <div class="form-row mt-2">
      <div class="col-md-6"><input name="lugar_entrega" class="form-control form-control-sm" placeholder="Lugar de entrega"></div>
      <div class="col-md-6"><input name="administrador_orden" class="form-control form-control-sm" placeholder="Administrador de la orden"></div>
    </div>
    <div class="form-row mt-2">
      <div class="col-md-4"><input name="multas" class="form-control form-control-sm" placeholder="Multas"></div>
      <div class="col-md-4"><input name="garantia" class="form-control form-control-sm" placeholder="Garant√≠a"></div>
      <div class="col-md-4"><input name="base_legal" class="form-control form-control-sm" placeholder="Base legal"></div>
    </div>

    <h6 class="mt-3">Detalle</h6>
    <table class="table table-sm table-bordered table-items" id="tabla-items">
      <thead class="thead-light">
        <tr>
          <th style="width:70px">Item</th>
          <th style="width:120px">CPC</th>
          <th>Descripci√≥n</th>
          <th style="width:120px">Unidad</th>
          <th style="width:120px">Cantidad</th>
          <th style="width:140px">V. Unitario</th>
          <th style="width:140px">V. Total</th>
          <th style="width:70px"></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button type="button" class="btn btn-outline-primary btn-sm" onclick="agregarFila()">+ Agregar √≠tem</button>

    <div class="form-row mt-3">
      <div class="col-md-4 ml-auto">
        <div class="input-group input-group-sm mb-1">
          <div class="input-group-prepend"><span class="input-group-text">Subtotal $</span></div>
          <input name="subtotal" id="subtotal" class="form-control" readonly>
        </div>
        <div class="input-group input-group-sm mb-1">
          <div class="input-group-prepend"><span class="input-group-text">IVA 12% $</span></div>
          <input name="iva" id="iva" class="form-control" readonly>
        </div>
        <div class="input-group input-group-sm">
          <div class="input-group-prepend"><span class="input-group-text">TOTAL $</span></div>
          <input name="total" id="total" class="form-control font-weight-bold" readonly>
        </div>
      </div>
    </div>

    <label class="mt-3">Observaciones</label>
    <textarea name="observaciones" class="form-control" rows="2"></textarea>

    <div class="mt-3">
      <button class="btn btn-success">üíæ Guardar OC</button>
      <a href="/admin_dashboard" class="btn btn-secondary">‚Üê Volver</a>
    </div>
  </form>
<script>
document.getElementById('sel_tarea_memo').addEventListener('change', async function () {
  const id = this.value;
  document.getElementById('tarea_id').value = id || '';
  if (!id) return;

  const res = await fetch('/api/tarea/' + id);
  if (!res.ok) return alert('No se pudo obtener la tarea');
  const t = await res.json();

  const area = document.querySelector('input[name="area_requirente"]');
  const obj  = document.querySelector('textarea[name="objeto"], input[name="objeto"]');
  const cert = document.querySelector('input[name="cert_presupuestaria"]');
  const nro  = document.querySelector('input[name="numero_oc"]');

  if (area) area.value = t.area_requirente || '';
  if (obj)  obj.value  = t.objeto_contratacion || '';
  if (cert) cert.value = t.numero_certificacion || '';

  // Forzar regla de √çnfima Cuant√≠a
  const tipo = (t.tipo_proceso || '').toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const esInfima = tipo.includes('infima') && tipo.includes('cuantia');

  if (esInfima && nro) {
    nro.value = t.codigo_proceso || '';
    nro.readOnly = true;
    nro.classList.add('bg-light');
    nro.title = 'Se toma del c√≥digo del proceso (√çnfima Cuant√≠a)';
  } else if (nro) {
    nro.readOnly = false;
    nro.classList.remove('bg-light');
    nro.title = '';
  }
});
</script>

<script>
function agregarFila() {
  const tb = document.querySelector('#tabla-items tbody');
  const idx = tb.querySelectorAll('tr').length + 1;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input name="item[]" class="form-control form-control-sm" value="${idx}"></td>
    <td><input name="cpc[]" class="form-control form-control-sm"></td>
    <td><input name="descripcion[]" class="form-control form-control-sm"></td>
    <td><input name="unidad[]" class="form-control form-control-sm"></td>
    <td><input name="cantidad[]" class="form-control form-control-sm" oninput="recalcular(this)"></td>
    <td><input name="v_unitario[]" class="form-control form-control-sm" oninput="recalcular(this)"></td>
    <td><input name="v_total[]" class="form-control form-control-sm" readonly></td>
    <td><button type="button" class="btn btn-sm btn-danger" onclick="eliminarFila(this)">X</button></td>
  `;
  tb.appendChild(tr);
}
function eliminarFila(btn){
  btn.closest('tr').remove();
  totales();
}
function toNum(v){ return parseFloat(v.replace(',','.')) || 0; }
function recalcular(inp){
  const tr = inp.closest('tr');
  const c = toNum(tr.querySelector('[name="cantidad[]"]').value);
  const u = toNum(tr.querySelector('[name="v_unitario[]"]').value);
  tr.querySelector('[name="v_total[]"]').value = (c*u).toFixed(2);
  totales();
}
function totales(){
  let sub = 0;
  document.querySelectorAll('[name="v_total[]"]').forEach(x => sub += toNum(x.value));
  const iva = +(sub * 0.12).toFixed(2);
  const tot = +(sub + iva).toFixed(2);
  document.getElementById('subtotal').value = sub.toFixed(2);
  document.getElementById('iva').value = iva.toFixed(2);
  document.getElementById('total').value = tot.toFixed(2);
}
// fila inicial
agregarFila();
</script>
</body>
</html>
